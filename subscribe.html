<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Subscription</title>
  <script src="https://sdk.minepi.com/pi-sdk.js"></script>
  <style>
    body {
      margin: 0;
      background: #2e004f url('background.png') no-repeat center center fixed;
      background-size: cover;
      font-family: Arial, sans-serif;
    }

    .subscription-box {
      background-color: #1a0033;
      padding: 30px;
      border-radius: 20px;
      box-shadow: 0 0 20px #ffcc00;
      text-align: center;
      width: 90%;
      max-width: 400px;
      margin: 100px auto;
    }

    .subscription-box h2 {
      color: gold;
      margin-bottom: 20px;
    }

    select {
      padding: 10px;
      font-size: 16px;
      margin-bottom: 20px;
      width: 100%;
      border-radius: 5px;
      border: none;
    }

    button {
      background-color: #a020f0;
      color: white;
      border: none;
      padding: 15px 30px;
      font-size: 18px;
      border-radius: 10px;
      cursor: pointer;
      width: 100%;
    }

    button:hover {
      background-color: #8000ff;
    }

    .message {
      margin-top: 20px;
      font-size: 16px;
      font-weight: bold;
    }

    .success {
      color: #00ff88;
    }

    .error {
      color: red;
    }

    #logo {
      position: absolute;
      top: 20px;
      left: 20px;
      width: 60px;
    }
  </style>
</head>
<body>
  <img id="logo" src="logo.png" alt="Logo" />
  <div class="subscription-box">
    <h2>Subscription</h2>
    <select id="subscriptionType">
      <option value="trial">Trial – 0.01 Pi (Sandbox)</option>
      <option value="1m">1 Month – 10 Pi</option>
      <option value="6m">6 Months – 55 Pi</option>
      <option value="12m">12 Months – 100 Pi</option>
    </select>
    <button onclick="subscribe()">Subscribe Now</button>
    <div id="message" class="message"></div>
  </div>

  <script>
    const subscriptionValues = {
      trial: 0.01,
      "1m": 10,
      "6m": 55,
      "12m": 100
    };

    async function subscribe() {
      const selectedType = document.getElementById("subscriptionType").value;
      const amount = subscriptionValues[selectedType];
      const messageDiv = document.getElementById("message");

      try {
        const scopes = ['username', 'payments'];
        const authResult = await Pi.authenticate(scopes, onIncompletePaymentFound);
        const username = authResult.user.username;
        const accessToken = authResult.accessToken;

        const paymentData = {
          amount: amount,
          memo: `GlobalLottoPI Subscription: ${selectedType}`,
          metadata: { type: selectedType },
          to: "GA43JVACMR2FM77IGK6AJ4F62SFSEFQCOKIHZ7NDCSQPXHLYJW7IMPDQ"
        };

        Pi.createPayment(paymentData, {
          sandbox: true,
          onReadyForServerApproval: async function (paymentId) {
            try {
              const res = await fetch("https://globallottopi-backend.onrender.com/verify-payment", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ paymentId, accessToken, username, amount, selectedType })
              });

              const data = await res.json();
              if (data.success) {
                messageDiv.innerHTML = "✅ Pagesa u krye me sukses.";
                messageDiv.className = "message success";
              } else {
                messageDiv.innerHTML = "❌ Pagesa dështoi.";
                messageDiv.className = "message error";
              }
            } catch (err) {
              messageDiv.innerHTML = "❌ Gabim në komunikim me serverin.";
              messageDiv.className = "message error";
            }
          },
          onCancelled: function () {
            messageDiv.innerHTML = "❌ Pagesa u anulua.";
            messageDiv.className = "message error";
          },
          onError: function (error) {
            messageDiv.innerHTML = "❌ Gabim: " + error;
            messageDiv.className = "message error";
          }
        });
      } catch (err) {
        messageDiv.innerHTML = "❌ Gabim gjatë autentifikimit: " + err;
        messageDiv.className = "message error";
      }
    }

    function onIncompletePaymentFound(payment) {
      console.warn("Incomplete payment found", payment);
      // Optional: You can attempt to resume payment here
    }
  </script>
</body>
</html>
